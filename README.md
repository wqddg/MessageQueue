# MessageQueue
消息队列  java API操作
# 常见的MQ
## ActiveMQ
### 介绍
他是遵循JMS规范的消息队列，有着P2P和pub/sub两种方式。

P2P模式当中：有队列和发送者和接收者。持久化的

pub/sub模式中：有主题，生产者和消费者。非持久化但是可以设置为持久化模式 需要一个指定的clientId和采用指定的消费模式
### 发送原理
发送分为同步发送和异步发送

生产者调用javaAPI send() 然后就会判断producerWindow大小是否为0 如果是阻塞等待ActiveMQ broker当中消息消费完成然后进行释放，判断同步还是异步，
* 同步发送：这里是同步则直接通过传输协议发送到ActiveMQ当中然后阻塞等待ActiveMQ broker中返回消息 结束
* 异步发送：这里是异步则直接将消息添加到producerWindow中，然后等待ActiveMQ broker的使用

### 消费原理
生产者调用receive方法，首先判断unconsumedMessages队列和prefetchSize是否为null 为0 如果为null 为0 则堵塞等待去拉取ActiveMQ中的broker数据。

获取到传输层push数据之后放入队列则接触阻塞，获取消息进行处理，处理完毕放入delivered队列当中随后设置ACK，开始异步返回到方法的返回值和ActiveMQ当中消费完成

### 消息确定ACK原理
在ACT_type当中，有着6个选项。当我们由unconsumedMessages队列取出进行处理的时候，处理完毕之后，如果出现异常者为0 或者3 开始进行重发，当重发的次数到达阈值便进入死信队列，

消费成功则返回2的词 代表消费成功。

消费失败：
* 出现异常
* 事务当中我们没有调用commit方法和rollback方法
* 非事务时，在事务选项中为手动模式 没有调用手动ACK方法


## RabbitMQ
### 角色分类
nameServer集群：服务注册于发现中心

Producer集群：消息发送者

Consumer集群：消息接收者

brokerClust：消息存储
### 部署方式
单master模式：这种模式下，broker重启或者宕机后，会导致服务不可用，不建议线上环境 个人测试使用

多master模式：多主模式，单个master掉线不会影响，但是会影响到此master中数据的实时性。无法顺序发送

多master模式+salve模式同步：效率比较低。主备无法切换  HA同步双写

多master模式+salve模式异步：效率比较高。先到队列当中  HA异步复制

同步刷盘：先发送到从节点，消息保存到磁盘 然后给生产者确认

异步刷盘：先发送给从节点，然后给生产确定 不用保存到磁盘
### Rocket的存储设计
**Topic**：用来设置一个消息发送的标识度

**Message**：消息主体

**Group**：消费者和生产者太多了 我们可以使用分组来完成区分

**offset**：消费位点，查看消费的位置

**queue**：发送的消息队列，保存TPS QPS
### 热点消息

### 消息消费
并发度 队列的调整。
### 消息存储目录

默认在用户账号目录下的store目录下

checkpoint文件：记录上一次节点时间。

commitLog文件夹：消息存储目录

consumerLog文件夹：消费队列节点目录

index文件夹：用来保证数据的索引

abort文件：出现异常就会生成的一个文件

config文件夹：运行中配置文件目录
### 关于CommitLog文件夹
顺序写随机读，默认1G一个文件的 每条消息 由4个字节来决定大小 后面在存储消息

配置文件可以进行修改
### consumerLog文件夹
这里面存储的是索引，
### 过期时间
非当前写文件，42小时内没有修改则判断可以是过期文件 调用定时任务完成删除操作

删除过程：每当删除一个文件之后要等待100MS的才删除下一个。如果这个文件拒绝删除 那么

删除条件：当数据达到服务器总磁盘的85%就会调用删除操作，每天凌晨4点也会调用删除操作



## Kafka
## Rocket MQ
# MQ的作用
## 异步处理
一般情况是串行和并行
假设一个操作 需要100ms的时间 如果有三个操作

并行时间为 200ms
串行时间为 300ms
但是使用MessageQueue就可以为150ms
## 应用解耦
多个功能融合在一起，必须等待一起成功才会成功，否则会失败

在这里通过消息队列，就可以解耦
## 流量削峰
秒杀任务和抢购任务时
## 日志处理
# AMQP简介
AMQP(高级消息队列协议)：进程之间互相传递异步消息的网络协议
## AMQP工作模式
发布者：发送消息到AMQP当中
AMQP：包含交换机和队列 交换机发送到队列当中
接收者：从AMQP接收到消息开始处理
# JMS规范
面对Java API的规范有着一套规范
